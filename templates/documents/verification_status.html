{% extends 'base.html' %}

{% block title %}Document Verification Status | {{ document.title }}{% endblock %}

{% block content %}
<div class="container-fluid py-4">
  <!-- Page Header -->
  <div class="row mb-4">
    <div class="col-12">
      <div class="d-flex justify-content-between align-items-center">
        <div>
          <h1 class="h3 mb-1">
            <i class="bi bi-info-circle me-2"></i>Document Verification Status
          </h1>
          <p class="text-muted mb-0">{{ document.title }}</p>
        </div>
        <div class="d-flex gap-2">
          <a href="{% url 'documents_archive' %}" class="btn btn-outline-secondary">
            <i class="bi bi-arrow-left"></i> Back to Archive
          </a>
          <a href="{% url 'download_document' document.id %}" class="btn btn-primary">
            <i class="bi bi-download"></i> Download
          </a>
        </div>
      </div>
    </div>
  </div>

  <div class="row">
    <!-- Document Details -->
    <div class="col-lg-8">
      <div class="card mb-4">
        <div class="card-header">
          <h5 class="mb-0">Document Details</h5>
        </div>
        <div class="card-body">
          <div class="row">
            <div class="col-md-6">
              <dl class="row">
                <dt class="col-sm-4">Title:</dt>
                <dd class="col-sm-8">{{ document.title }}</dd>

                <dt class="col-sm-4">Type:</dt>
                <dd class="col-sm-8">{{ document.get_doc_type_display }}</dd>

                <dt class="col-sm-4">Client:</dt>
                <dd class="col-sm-8">{{ document.client }}</dd>

                <dt class="col-sm-4">Version:</dt>
                <dd class="col-sm-8">v{{ document.version }}</dd>

                <dt class="col-sm-4">Uploaded:</dt>
                <dd class="col-sm-8">{{ document.uploaded_at|date:"M d, Y H:i" }}</dd>

                <dt class="col-sm-4">Uploaded By:</dt>
                <dd class="col-sm-8">{{ document.uploaded_by.get_full_name|default:document.uploaded_by.email }}</dd>
              </dl>
            </div>
            <div class="col-md-6">
              <dl class="row">
                <dt class="col-sm-4">Status:</dt>
                <dd class="col-sm-8">
                  <span class="badge bg-{% if document.verification_status == 'approved' %}success{% elif document.verification_status == 'rejected' %}danger{% elif document.verification_status == 'pending' %}warning{% elif document.verification_status == 'under_review' %}info{% else %}secondary{% endif %}">
                    {{ document.get_verification_status_display }}
                  </span>
                </dd>

                <dt class="col-sm-4">Workflow:</dt>
                <dd class="col-sm-8">{{ document.get_approval_workflow_display }}</dd>

                <dt class="col-sm-4">Requires Signature:</dt>
                <dd class="col-sm-8">
                  {% if document.requires_signature %}
                    <span class="text-success">Yes</span>
                    {% if document.is_signed %}
                      <i class="bi bi-check-circle-fill text-success ms-1"></i>
                    {% else %}
                      <i class="bi bi-x-circle-fill text-warning ms-1"></i>
                    {% endif %}
                  {% else %}
                    <span class="text-muted">No</span>
                  {% endif %}
                </dd>

                <dt class="col-sm-4">Is Template:</dt>
                <dd class="col-sm-8">
                  {% if document.is_template %}
                    <span class="text-info">Yes</span>
                    <i class="bi bi-file-earmark-text text-info ms-1"></i>
                  {% else %}
                    <span class="text-muted">No</span>
                  {% endif %}
                </dd>

                {% if document.expiry_date %}
                <dt class="col-sm-4">Expiry Date:</dt>
                <dd class="col-sm-8">
                  {{ document.expiry_date|date:"M d, Y" }}
                  {% if document.is_expired %}
                    <span class="badge bg-danger ms-1">Expired</span>
                  {% elif document.days_until_expiry <= 30 %}
                    <span class="badge bg-warning ms-1">{{ document.days_until_expiry }} days left</span>
                  {% endif %}
                </dd>
                {% endif %}
              </dl>
            </div>
          </div>

          {% if document.notes %}
          <div class="mt-3">
            <h6>Notes:</h6>
            <p class="text-muted">{{ document.notes }}</p>
          </div>
          {% endif %}
        </div>
      </div>

      <!-- Approval History -->
      {% if document.approved_by.exists or document.rejected_by %}
      <div class="card mb-4">
        <div class="card-header">
          <h5 class="mb-0">Approval History</h5>
        </div>
        <div class="card-body">
          {% if document.approved_by.exists %}
          <div class="mb-3">
            <h6 class="text-success">
              <i class="bi bi-check-circle me-2"></i>Approved By:
            </h6>
            <ul class="list-unstyled">
              {% for user in approved_users %}
              <li class="mb-1">
                <i class="bi bi-person-check text-success me-2"></i>
                {{ user.get_full_name|default:user.email }}
                {% if document.approved_at %}
                  <small class="text-muted">on {{ document.approved_at|date:"M d, Y H:i" }}</small>
                {% endif %}
              </li>
              {% endfor %}
            </ul>
          </div>
          {% endif %}

          {% if document.rejected_by %}
          <div class="mb-3">
            <h6 class="text-danger">
              <i class="bi bi-x-circle me-2"></i>Rejected By:
            </h6>
            <p class="mb-1">
              <i class="bi bi-person-x text-danger me-2"></i>
              {{ document.rejected_by.get_full_name|default:document.rejected_by.email }}
              {% if document.rejected_at %}
                <small class="text-muted">on {{ document.rejected_at|date:"M d, Y H:i" }}</small>
              {% endif %}
            </p>
          </div>
          {% endif %}

          {% if document.approval_notes %}
          <div>
            <h6>Approval Notes:</h6>
            <p class="text-muted">{{ document.approval_notes }}</p>
          </div>
          {% endif %}
        </div>
      </div>
      {% endif %}

      <!-- Digital Signature -->
      {% if document.is_signed and document.signature_data %}
      <div class="card mb-4">
        <div class="card-header">
          <h5 class="mb-0">
            <i class="bi bi-pen me-2"></i>Digital Signature
          </h5>
        </div>
        <div class="card-body">
          <div class="text-center">
            <img src="{{ document.signature_data }}" alt="Digital Signature" class="img-fluid border" style="max-width: 400px;">
          </div>
          <div class="mt-3 text-center">
            <form method="post" action="{% url 'remove_signature' document.id %}" class="d-inline">
              {% csrf_token %}
              <button type="submit" class="btn btn-outline-danger btn-sm">
                <i class="bi bi-trash"></i> Remove Signature
              </button>
            </form>
          </div>
        </div>
      </div>
      {% endif %}
    </div>

    <!-- Actions Sidebar -->
    <div class="col-lg-4">
      <div class="card">
        <div class="card-header">
          <h5 class="mb-0">Actions</h5>
        </div>
        <div class="card-body">
          <div class="d-grid gap-2">
            {% if document.verification_status == 'pending' and document.approval_workflow != 'none' %}
              <form method="post" action="{% url 'approve_document' document.id %}">
                {% csrf_token %}
                <div class="mb-3">
                  <label class="form-label">Approval Notes (optional)</label>
                  <textarea class="form-control" name="approval_notes" rows="2"></textarea>
                </div>
                <button type="submit" class="btn btn-success w-100">
                  <i class="bi bi-check-circle me-2"></i>Approve Document
                </button>
              </form>

              <hr>

              <form method="post" action="{% url 'reject_document' document.id %}">
                {% csrf_token %}
                <div class="mb-3">
                  <label class="form-label">Reason for Rejection <span class="text-danger">*</span></label>
                  <textarea class="form-control" name="approval_notes" rows="3" required></textarea>
                </div>
                <button type="submit" class="btn btn-danger w-100">
                  <i class="bi bi-x-circle me-2"></i>Reject Document
                </button>
              </form>
            {% endif %}

            {% if document.requires_signature and not document.is_signed %}
              <hr>

              <button class="btn btn-info w-100" data-bs-toggle="modal" data-bs-target="#signModal">
                <i class="bi bi-pen me-2"></i>Add Digital Signature
              </button>
            {% endif %}

            <hr>

            <a href="{% url 'download_document' document.id %}" class="btn btn-primary">
              <i class="bi bi-download me-2"></i>Download Document
            </a>

            <form method="post" action="{% url 'send_document' document.id %}" class="d-inline">
              {% csrf_token %}
              <button type="submit" class="btn btn-outline-success w-100">
                <i class="bi bi-envelope me-2"></i>Send to Client
              </button>
            </form>
          </div>
        </div>
      </div>

      <!-- Signature Modal -->
      {% if document.requires_signature and not document.is_signed %}
      <div class="modal fade" id="signModal" tabindex="-1">
        <div class="modal-dialog">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title">Digital Signature</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="post" action="{% url 'sign_document' document.id %}">
              {% csrf_token %}
              <div class="modal-body">
                <p>Sign "{{ document.title }}" digitally:</p>
                <div class="mb-3">
                  <canvas id="signatureCanvas" class="border w-100" height="200"></canvas>
                  <input type="hidden" name="signature_data" id="signatureData">
                </div>
                <button type="button" class="btn btn-sm btn-outline-secondary" onclick="clearSignature()">Clear</button>
              </div>
              <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="submit" class="btn btn-primary">Sign Document</button>
              </div>
            </form>
          </div>
        </div>
      </div>
      {% endif %}
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
function clearSignature() {
  const canvas = document.getElementById('signatureCanvas');
  const ctx = canvas.getContext('2d');
  ctx.clearRect(0, 0, canvas.width, canvas.height);
  document.getElementById('signatureData').value = '';
}

document.addEventListener('DOMContentLoaded', function() {
  const canvas = document.getElementById('signatureCanvas');
  if (canvas) {
    const ctx = canvas.getContext('2d');
    let drawing = false;

    canvas.addEventListener('mousedown', () => drawing = true);
    canvas.addEventListener('mouseup', () => drawing = false);
    canvas.addEventListener('mouseout', () => drawing = false);

    canvas.addEventListener('mousemove', function(e) {
      if (!drawing) return;

      const rect = canvas.getBoundingClientRect();
      const x = e.clientX - rect.left;
      const y = e.clientY - rect.top;

      ctx.lineWidth = 2;
      ctx.lineCap = 'round';
      ctx.strokeStyle = '#000';

      ctx.lineTo(x, y);
      ctx.stroke();
      ctx.beginPath();
      ctx.moveTo(x, y);
    });

    // Save signature data when modal is submitted
    const modal = canvas.closest('.modal');
    modal.addEventListener('submit', function() {
      document.getElementById('signatureData').value = canvas.toDataURL();
    });
  }
});
</script>
{% endblock %}
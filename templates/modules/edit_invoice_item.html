{% extends 'base.html' %}

{% block title %}Edit Item | Invoice {{ invoice.number }}{% endblock %}

{% block content %}
  <div class="d-flex align-items-center justify-content-between flex-wrap gap-2 mb-3">
    <div>
      <h1 class="h4 mb-1">Edit Item</h1>
      <div class="text-muted">Invoice {{ invoice.number }} â€” {{ invoice.client }}</div>
    </div>
    <a href="{% url 'invoice_detail' invoice.id %}" class="btn btn-outline-secondary btn-sm">Back</a>
  </div>

  <div class="card shadow-sm">
    <div class="card-body">
      <form method="post" class="row g-3" novalidate>
        {% csrf_token %}
        {% if form.non_field_errors %}
          <div class="col-12">
            <div class="alert alert-danger mb-0">{{ form.non_field_errors }}</div>
          </div>
        {% endif %}

        <div class="col-12 col-md-6">
          <label class="form-label">{{ form.product.label }}</label>
          {{ form.product }}
          <div class="text-danger small">{{ form.product.errors }}</div>
        </div>
        <div class="col-12 col-md-6">
          <label class="form-label">{{ form.service.label }}</label>
          {{ form.service }}
          <div class="text-danger small">{{ form.service.errors }}</div>
        </div>
        <div class="col-12">
          <label class="form-label">{{ form.description.label }}</label>
          {{ form.description }}
          <div class="text-danger small">{{ form.description.errors }}</div>
        </div>

        <div class="col-12 col-md-4">
          <label class="form-label">{{ form.quantity.label }}</label>
          {{ form.quantity }}
          <div class="text-danger small">{{ form.quantity.errors }}</div>
        </div>
        <div class="col-12 col-md-4">
          <label class="form-label">{{ form.unit_price.label }}</label>
          {{ form.unit_price }}
          <div class="text-danger small">{{ form.unit_price.errors }}</div>
        </div>
        <div class="col-12 col-md-4">
          <label class="form-label">Total</label>
          <input id="line_total" class="form-control" type="text" value="" readonly />
        </div>

        <div class="col-12">
          <div class="form-check">
            {{ form.vat_exempt }}
            <label class="form-check-label" for="{{ form.vat_exempt.id_for_label }}">Not VAT eligible</label>
          </div>
          <div class="text-danger small">{{ form.vat_exempt.errors }}</div>
        </div>

        <div class="col-12 d-flex gap-2">
          <button type="submit" class="btn btn-primary">Save Changes</button>
          <a href="{% url 'invoice_detail' invoice.id %}" class="btn btn-outline-secondary">Cancel</a>
        </div>
      </form>
    </div>
  </div>

  <script>
    (function () {
      const qtyEl = document.getElementById("{{ form.quantity.id_for_label }}");
      const unitEl = document.getElementById("{{ form.unit_price.id_for_label }}");
      const totalEl = document.getElementById("line_total");

      function toNumber(val) {
        const n = parseFloat((val || "").toString().replace(/,/g, ""));
        return Number.isFinite(n) ? n : 0;
      }

      function fmt2(val) {
        return val.toFixed(2);
      }

      function recalc() {
        const qty = toNumber(qtyEl && qtyEl.value);
        const unit = toNumber(unitEl && unitEl.value);
        const total = qty * unit;
        totalEl.value = fmt2(total);
      }

      if (qtyEl) qtyEl.addEventListener("input", recalc);
      if (unitEl) unitEl.addEventListener("input", recalc);
      recalc();
    })();
  </script>
{% endblock %}

{% extends 'base.html' %}
{% load formatting %}

{% block title %}Invoice {{ invoice.number }} | Jambas Imaging{% endblock %}

{% block content %}
  <div class="d-flex align-items-center justify-content-between flex-wrap gap-2 mb-3">
    <div>
      <h1 class="h4 mb-1">Invoice {{ invoice.number }}</h1>
      <div class="text-muted">Client: <a class="text-decoration-none" href="{% url 'client_history' invoice.client.id %}">{{ invoice.client }}</a></div>
    </div>
    <div class="d-flex gap-2">
      <a href="{% url 'invoice_pdf' invoice.id %}" class="btn btn-outline-primary btn-sm">Download Invoice PDF</a>
      <a href="{% url 'invoice_pdf' invoice.id %}?inline=1" class="btn btn-outline-secondary btn-sm js-doc-preview" data-title="Invoice PDF">Preview PDF</a>
      {% if invoice.status != 'paid' and invoice.status != 'cancelled' %}
        <a href="{% url 'edit_invoice' invoice.id %}" class="btn btn-outline-secondary btn-sm">Edit</a>
      {% endif %}
      {% if is_admin and invoice.status != 'paid' and invoice.status != 'cancelled' %}
        <form method="post" action="{% url 'cancel_invoice' invoice.id %}" onsubmit="return window.__cancelInvoiceWithReason(this);">
          {% csrf_token %}
          <input type="hidden" name="cancel_reason" value="" />
          <button type="submit" class="btn btn-outline-danger btn-sm">Cancel</button>
        </form>
      {% endif %}
      <form method="post" action="{% url 'send_invoice' invoice.id %}">
        {% csrf_token %}
        <button type="submit" class="btn btn-primary btn-sm">Send Invoice</button>
      </form>
      <a href="{% url 'invoices' %}" class="btn btn-outline-secondary btn-sm">Back</a>
    </div>
  </div>

  <div class="card shadow-sm mb-3">
    <div class="card-body">
      <div class="row g-2 align-items-end">
        <div class="col-12 col-md-5">
          <div class="text-muted small">Prepared by</div>
          <div class="fw-semibold">{{ invoice.prepared_by_name|default:invoice.created_by.email|default:"-" }}</div>
        </div>
        <div class="col-12 col-md-7">
          <form method="post" action="{% url 'sign_invoice' invoice.id %}" class="row g-2 align-items-end">
            {% csrf_token %}
            <div class="col-12 col-md-8">
              <label class="form-label small text-muted mb-1">Approved by (from Shift Identity)</label>
              <input type="text" class="form-control" value="{{ signature_form.name.value|default:'' }}" readonly />
              <input type="hidden" name="name" value="{{ signature_form.name.value|default:'' }}" />
            </div>
            <div class="col-12 col-md-4">
              <button type="submit" class="btn btn-outline-primary btn-sm w-100">Approve</button>
            </div>
          </form>
          {% if invoice.signed_by_name %}
            <div class="small text-muted mt-2">Approved by <span class="fw-semibold">{{ invoice.signed_by_name }}</span>{% if invoice.signed_at %} at {{ invoice.signed_at|date:"Y-m-d H:i" }}{% endif %}</div>
          {% endif %}
        </div>
      </div>
    </div>
  </div>

  <div class="row g-3 mb-3">
    <div class="col-12 col-md-3">
      <div class="card shadow-sm h-100">
        <div class="card-body">
          <div class="text-muted small">Total</div>
          <div class="h5 mb-0">{{ invoice.currency }} {{ totals.total|money }}</div>
        </div>
      </div>
    </div>
    <div class="col-12 col-md-3">
      <div class="card shadow-sm h-100">
        <div class="card-body">
          <div class="text-muted small">Paid</div>
          <div class="h5 mb-0">{{ invoice.currency }} {{ totals.paid|money }}</div>
        </div>
      </div>
    </div>
    <div class="col-12 col-md-3">
      <div class="card shadow-sm h-100">
        <div class="card-body">
          <div class="text-muted small">Balance</div>
          <div class="h5 mb-0">{{ invoice.currency }} {{ totals.balance|money }}</div>
        </div>
      </div>
    </div>
    <div class="col-12 col-md-3">
      <div class="card shadow-sm h-100">
        <div class="card-body">
          <div class="text-muted small">Status</div>
          <div class="h5 mb-0 text-capitalize">{{ invoice.status }}</div>
          {% if invoice.status == 'cancelled' %}
            {% if invoice.cancelled_at %}<div class="small text-muted mt-1">Cancelled at {{ invoice.cancelled_at|date:"Y-m-d H:i" }}</div>{% endif %}
            {% if invoice.cancel_reason %}<div class="small text-muted">Reason: {{ invoice.cancel_reason }}</div>{% endif %}
          {% endif %}
        </div>
      </div>
    </div>
  </div>

  <script>
    window.__cancelInvoiceWithReason = function (formEl) {
      try {
        var reason = window.prompt('Cancellation reason (required):', '') || '';
        reason = reason.trim();
        if (!reason) {
          alert('Cancellation reason is required.');
          return false;
        }
        var input = formEl.querySelector('input[name="cancel_reason"]');
        if (input) input.value = reason;
        return window.confirm('Cancel this invoice?');
      } catch (e) {
        return window.confirm('Cancel this invoice?');
      }
    };
  </script>

  <div class="row g-3">
    <div class="col-12 col-lg-7">
      <div class="card shadow-sm">
        <div class="card-header bg-white">
          <div class="d-flex align-items-center justify-content-between flex-wrap gap-2">
            <div class="fw-semibold">Items</div>
            <a href="{% url 'add_invoice_item' invoice.id %}" class="btn btn-primary btn-sm">+ Add Item</a>
          </div>
        </div>
        <div class="card-body p-0">
          <div class="table-responsive">
            <table class="table mb-0 align-middle">
              <thead class="table-light">
                <tr>
                  <th>Description</th>
                  <th class="text-end">Qty</th>
                  <th class="text-end">Unit</th>
                  <th class="text-end">Line Total</th>
                </tr>
              </thead>
              <tbody>
                {% for it in items %}
                  <tr>
                    <td>
                      <div class="fw-semibold">{{ it.description }}</div>
                      {% if it.product %}<div class="small text-muted">Product: {{ it.product }}</div>{% endif %}
                      {% if it.service %}<div class="small text-muted">Service: {{ it.service }}</div>{% endif %}
                      <div class="d-flex gap-2 mt-1">
                        <a class="btn btn-outline-primary btn-sm" href="{% url 'edit_invoice_item' invoice.id it.id %}">Edit</a>
                        <form method="post" action="{% url 'delete_invoice_item' invoice.id it.id %}">
                          {% csrf_token %}
                          <button type="submit" class="btn btn-outline-danger btn-sm">Delete</button>
                        </form>
                      </div>
                    </td>
                    <td class="text-end">{{ it.quantity }}</td>
                    <td class="text-end">{{ invoice.currency }} {{ it.unit_price }}</td>
                    <td class="text-end">{{ invoice.currency }} {{ it.line_total }}</td>
                  </tr>
                {% empty %}
                  <tr><td colspan="4" class="text-center text-muted py-4">No items on this invoice.</td></tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
        <div class="card-footer bg-white">
          <div class="d-flex justify-content-end">
            <div style="min-width: 280px;">
              <div class="d-flex justify-content-between"><span class="text-muted">Subtotal</span><span>{{ invoice.currency }} {{ totals.subtotal|money }}</span></div>
              <div class="d-flex justify-content-between"><span class="text-muted">VAT</span><span>{{ invoice.currency }} {{ totals.vat|money }}</span></div>
              <div class="d-flex justify-content-between fw-semibold"><span>Total</span><span>{{ invoice.currency }} {{ totals.total|money }}</span></div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="col-12 col-lg-5">
      <div class="card shadow-sm mb-3">
        <div class="card-header bg-white">
          <div class="d-flex align-items-center justify-content-between">
            <div class="fw-semibold">Archived PDFs</div>
            <a class="btn btn-outline-secondary btn-sm" href="{% url 'documents_archive' %}">Open Archive</a>
          </div>
        </div>
        <div class="card-body p-0">
          <div class="table-responsive">
            <table class="table table-sm mb-0 align-middle">
              <thead class="table-light">
                <tr>
                  <th>Title</th>
                  <th>Type</th>
                  <th>v</th>
                  <th class="text-end">Download</th>
                </tr>
              </thead>
              <tbody>
                {% for d in invoice_documents %}
                  <tr>
                    <td>{{ d.title|default:'(Untitled)' }}</td>
                    <td>{{ d.doc_type_label }}</td>
                    <td>{{ d.version }}</td>
                    <td class="text-end">
                      <a class="btn btn-outline-primary btn-sm" href="{% url 'download_document' d.id %}"><i class="bi bi-download"></i></a>
                      <a class="btn btn-outline-secondary btn-sm js-doc-preview" href="{% url 'download_document' d.id %}?inline=1" data-title="Preview"><i class="bi bi-eye"></i></a>
                    </td>
                  </tr>
                {% empty %}
                  <tr><td colspan="4" class="text-center text-muted py-3">No archived PDFs yet.</td></tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <div class="card shadow-sm mb-3">
        <div class="card-header bg-white">
          <div class="fw-semibold">Record Payment</div>
        </div>
        <div class="card-body">
          <form method="post" action="{% url 'add_invoice_payment' invoice.id %}">
            {% csrf_token %}
            {{ payment_form.non_field_errors }}
            <div class="row g-2">
              <div class="col-12">
                <label class="form-label">Method</label>
                {{ payment_form.method }}
                <div class="text-danger small">{{ payment_form.method.errors }}</div>
              </div>
              <div class="col-12">
                <label class="form-label">Other (specify)</label>
                {{ payment_form.method_other }}
                <div class="text-danger small">{{ payment_form.method_other.errors }}</div>
              </div>
              <div class="col-12">
                <label class="form-label">Amount</label>
                {{ payment_form.amount }}
                <div class="text-danger small">{{ payment_form.amount.errors }}</div>
              </div>
              <div class="col-12">
                <label class="form-label">Reference</label>
                {{ payment_form.reference }}
                <div class="text-danger small">{{ payment_form.reference.errors }}</div>
              </div>
              <div class="col-12">
                <label class="form-label">Paid at</label>
                {{ payment_form.paid_at }}
                <div class="text-danger small">{{ payment_form.paid_at.errors }}</div>
              </div>
              <div class="col-12">
                <label class="form-label">Notes</label>
                {{ payment_form.notes }}
                <div class="text-danger small">{{ payment_form.notes.errors }}</div>
              </div>
              <div class="col-12">
                <button type="submit" class="btn btn-primary btn-sm w-100">Save Payment</button>
              </div>
            </div>
          </form>
        </div>
      </div>

      <div class="card shadow-sm">
        <div class="card-header bg-white">
          <div class="d-flex align-items-center justify-content-between">
            <div class="fw-semibold">Payments</div>
            <span class="text-muted small">Latest first</span>
          </div>
        </div>
        <div class="card-body p-0">
          <div class="table-responsive">
            <table class="table table-hover mb-0 align-middle">
              <thead class="table-light">
                <tr>
                  <th>Date</th>
                  <th>Method</th>
                  <th class="text-end">Amount</th>
                  <th class="text-end">Receipt</th>
                  {% if is_admin %}
                    <th class="text-end">Actions</th>
                  {% endif %}
                </tr>
              </thead>
              <tbody>
                {% for p in payments %}
                  <tr>
                    <td>{{ p.paid_at|date:"Y-m-d H:i" }}</td>
                    <td>{{ p.method_label }}</td>
                    <td class="text-end">{{ invoice.currency }} {{ p.amount|money }}</td>
                    <td class="text-end">
                      <a class="btn btn-outline-primary btn-sm" href="{% url 'payment_receipt_pdf' invoice.id p.id %}">PDF</a>
                      <a class="btn btn-outline-secondary btn-sm js-doc-preview" href="{% url 'payment_receipt_pdf' invoice.id p.id %}?inline=1" data-title="Receipt PDF"><i class="bi bi-eye"></i></a>
                      {% if p.archived_receipt_doc %}
                        <a class="btn btn-outline-secondary btn-sm" href="{% url 'download_document' p.archived_receipt_doc.id %}" title="Download archived receipt"><i class="bi bi-archive"></i></a>
                        <a class="btn btn-outline-secondary btn-sm js-doc-preview" href="{% url 'download_document' p.archived_receipt_doc.id %}?inline=1" data-title="Archived Receipt"><i class="bi bi-eye"></i></a>
                      {% endif %}
                      <form method="post" action="{% url 'send_payment_receipt' invoice.id p.id %}" class="d-inline">
                        {% csrf_token %}
                        <button class="btn btn-outline-success btn-sm" type="submit">Send</button>
                      </form>
                    </td>
                    {% if is_admin %}
                      <td class="text-end">
                        {% if p.is_refund_window_open %}
                          <a class="btn btn-outline-warning btn-sm" href="{% url 'refund_payment' invoice.id p.id %}">Refund</a>
                        {% else %}
                          <button class="btn btn-outline-secondary btn-sm" type="button" disabled title="Refunds are allowed within 21 days of payment date.">Refund</button>
                        {% endif %}
                        <form method="post" action="{% url 'delete_invoice_payment' invoice.id p.id %}" class="d-inline" onsubmit="return confirm('Delete this payment?');">
                          {% csrf_token %}
                          <button class="btn btn-outline-danger btn-sm" type="submit">Delete</button>
                        </form>
                      </td>
                    {% endif %}
                  </tr>
                  {% if p.reference or p.notes %}
                    <tr class="table-light">
                      <td colspan="{% if is_admin %}5{% else %}4{% endif %}" class="small text-muted">
                        {% if p.reference %}<div><span class="fw-semibold">Ref:</span> {{ p.reference }}</div>{% endif %}
                        {% if p.notes %}<div><span class="fw-semibold">Notes:</span> {{ p.notes }}</div>{% endif %}
                      </td>
                    </tr>
                  {% endif %}
                {% empty %}
                  <tr><td colspan="{% if is_admin %}5{% else %}4{% endif %}" class="text-center text-muted py-4">No payments yet.</td></tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
      </div>

      {% if refunds %}
        <div class="card shadow-sm mt-3">
          <div class="card-header bg-white">
            <div class="d-flex align-items-center justify-content-between">
              <div class="fw-semibold">Refunds</div>
              <span class="text-muted small">Latest first</span>
            </div>
          </div>
          <div class="card-body p-0">
            <div class="table-responsive">
              <table class="table table-hover mb-0 align-middle">
                <thead class="table-light">
                  <tr>
                    <th>Date</th>
                    <th>Payment</th>
                    <th class="text-end">Amount</th>
                    <th>By</th>
                    {% if is_admin %}
                      <th class="text-end">Actions</th>
                    {% endif %}
                  </tr>
                </thead>
                <tbody>
                  {% for r in refunds %}
                    <tr>
                      <td>{{ r.refunded_at|date:"Y-m-d H:i" }}</td>
                      <td>#{{ r.payment.id }}</td>
                      <td class="text-end">{{ invoice.currency }} {{ r.amount|money }}</td>
                      <td>{{ r.refunded_by|default:"-" }}</td>
                      {% if is_admin %}
                        <td class="text-end">
                          <form method="post" action="{% url 'delete_payment_refund' invoice.id r.id %}" class="d-inline" onsubmit="return confirm('Delete this refund?');">
                            {% csrf_token %}
                            <button class="btn btn-outline-danger btn-sm" type="submit">Delete</button>
                          </form>
                        </td>
                      {% endif %}
                    </tr>
                    {% if r.reference or r.notes %}
                      <tr class="table-light">
                        <td colspan="{% if is_admin %}5{% else %}4{% endif %}" class="small text-muted">
                          {% if r.reference %}<div><span class="fw-semibold">Ref:</span> {{ r.reference }}</div>{% endif %}
                          {% if r.notes %}<div><span class="fw-semibold">Notes:</span> {{ r.notes }}</div>{% endif %}
                        </td>
                      </tr>
                    {% endif %}
                  {% endfor %}
                </tbody>
              </table>
            </div>
          </div>
        </div>
      {% endif %}
    </div>
  </div>
{% endblock %}
